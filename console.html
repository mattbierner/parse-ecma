---
layout: base
---
<div class="content">
    <div>
        <div class='console'>
            <h2>Input</h2>
            <textarea rows='20'></textarea>
            <button>Tokenize</button>
        </div>
        <div>
            <h4>Lex Out</h4>
            <pre class='LexError'></pre>
            <pre class='LexOut'></pre>
        </div>
    </div>
    <div class='output'>

        <div>
            <h4>Parse Out</h4>
            <pre class='ParseError'></pre>
            <pre class='ParseOut'></pre>
        </div>
    </div>
    
    <div class='TokenInfo'>
        <h3>Token Info</h3>
        <ul>
            <li class='TypeInfo'>
                <div class='Key'>Type</div>
                <div class='Value'></div>
            </li>
            <li class='LocationInfo'>
                <div class='Key'>Location</div>
                <div class='Value'></div>
            </li>
            <li class='ValueInfo'>
                <div class='Key'>Value</div>
                <pre class='Value'></pre>
            </li>
        </ul>
    </div>
</div>

<script type="application/javascript" src="javascripts/require.js"></script>
<script src="javascripts/jquery-1.8.3.min.js"></script>
<script type="application/javascript">
    requirejs.config({
        paths: {
            'parse': 'dependencies/parse/lib',
            'nu': 'dependencies/nu/lib',
            
            'ecma': 'lib'
        }
    });
    $(function(){
        require(['parse/parse', 'nu/stream', 'ecma/lex/lexer', 'ecma/parse/parser', 'ecma/ast/node'],
            function(parse, stream, lexer, parser, node)
        {
            var lexOut = $('.LexOut');
            
            $('.Token').live('hover', function() {
                $('.TokenInfo .TypeInfo .Value').text($(this).data('type'));
                $('.TokenInfo .ValueInfo .Value').text($(this).data('value'));
                $('.TokenInfo .LocationInfo .Value').text($(this).data('location'));
            });
            
            $('.Node').live('mouseover mouseout', function(event) {
                event.stopPropagation();
                
                var nodeLoc = $(this).data('location');
                if (event.type == 'mouseover') {
                    $(this).addClass('Active');
                    lexOut.children().each(function(){
                        var loc = $(this).data('location');
                        if (loc.start.compare(nodeLoc.start) >= 0) {
                            if (loc.end.compare(nodeLoc.end) <= 0) {
                                $(this).addClass('Active');
                            } else {
                                return false;
                            }
                        }
                    });
                } else {
                    $(this).removeClass('Active');
                    lexOut.children('.Active').removeClass('Active');
                }
            });
            
            
            var walk = function(ast, f) {
                if (ast instanceof node.Node) {
                    var n = $("<div class='Node " + ast.type +"'><span class='NodeType'>"+ast.type+"</span></div>")
                        .data('location', ast.loc);
                    
                    Object.keys(ast).forEach(function(key) {
                        walk(ast[key], function(x) { n.append($("<div>" + key + ": </div>").append(x)); });
                    });
                    return f(n);
                }
                if (Array.isArray(ast)) {
                    var n = $("<div class='Array'></div>");
                    
                    for (var i = 0; i < ast.length; ++i) {
                        walk(ast[i], function(x) { n.append(x); });
                    }
                    return f(n);
                }
                return f($("<span>" + ast + "</span>"));
            };
            
            $('button').click(function() {
                var input = $('textarea').val();
                
                lexOut.children().remove();
                $('.ParseOut').children().remove();
                $('.ParseOut').text('');
                $('.ParseError').text('');
                $('.LexError').text('');
                
                var nodes;
                try {
                    nodes = lexer.lex(input);
                    stream.forEach(function(v) {
                        var type =  v.type,
                            value = (type === 'Whitespace' ? '' : v.value),
                            location = v.loc;
                        lexOut.append($("<span class='Token'>" + value + "</span>")
                            .addClass(function() {
                                if (v.type === 'Whitespace' && v.value === '\t') {
                                    return v.type + " Tab";
                                }
                                return v.type;
                            }).data({
                                'type': type,
                                'value': value,
                                'location': location
                            }));
                    }, nodes);
                } catch (e) {
                    $('.LexError').text(e);
                    return;
                }

                try
                {
                    var start = new Date().getTime();
                    //console.profile();
                   
                    var ast = parser.parseStream(nodes);
                    
                    //console.profileEnd();
                    var end = new Date().getTime();
                    console.log(end - start);
                    
                    $('.ParseError').text('');
                    walk(ast, function(x){
                        $('.ParseOut').append(x);
                    });
                } catch (e) {
                    $('.ParseError').text(e);
                }
            });
        });
    });
</script>
